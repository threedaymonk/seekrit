#! /usr/bin/ruby1.8
require 'seekrit/store'
require 'seekrit/interactor'
require 'highline/import'
require 'fileutils'

DATAFILE = ENV['HOME'] + '/.config/seekrit/secrets'

def interactor(&blk)
  err = nil
  FileUtils.mkdir_p(File.dirname(DATAFILE))
  File.open(DATAFILE, "a+") do |file|
    3.times do
      begin
        password = ask('Enter password: '){ |q| q.echo = false }
        store = Seekrit::Store.new(password, file)
        yield Seekrit::Interactor.new(store)
        return
      rescue Seekrit::DecryptionError => err
      end
    end
    puts err.message
    exit 1
  end
end

command = ARGV.shift
names = ARGV
case command
when 'show', 's'
  interactor{ |i| i.show names }
when 'edit', 'e'
  interactor{ |i| i.edit names }
when 'list', 'l'
  interactor{ |i| i.list names }
when 'delete'
  interactor{ |i| i.delete names }
when 'rename'
  interactor{ |i| i.rename names.shift, names.shift }
when 'export'
  interactor{ |i| i.export names.shift }
when 'import'
  interactor{ |i| i.import names.shift }
else
  puts "Unknown command '#{command}'", '' if command
puts <<END
list                      List all entries.
show name(s)              Show matching entries.
edit name(s)              Create or modify entries.
delete name(s)            Delete entries.
rename old_name new_name  Rename entry.
END
end
